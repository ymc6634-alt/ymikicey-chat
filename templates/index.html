<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YMIKICEY Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- ==================== SURVEY OVERLAY ==================== -->
    <div id="survey-overlay" class="overlay">
        <div class="survey-box">
            <h2>📝 Quick Survey</h2>
            <p>Before we start, tell me a bit:</p>

            <label>Why are you gonna use this AI bot?</label>
            <input type="text" id="survey-why" placeholder="For fun, learning, etc.">

            <label>Where did you hear about it?</label>
            <input type="text" id="survey-source" placeholder="Friend, internet, etc.">

            <div class="survey-buttons">
                <button id="survey-submit" class="start">✅ Start Chatting</button>
                <button id="survey-skip" class="skip">⏭️ Skip</button>
            </div>
        </div>
    </div>

    <!-- ==================== FEEDBACK POPUP ==================== -->
    <div id="feedback-popup" class="overlay" style="display:none;">
        <div class="survey-box">
            <h2>💭 Feedback</h2>
            <p>How’s your experience so far?</p>
            <button class="feedback-btn" data-feedback="good">👍 Good</button>
            <button class="feedback-btn" data-feedback="bad">👎 Bad</button>
        </div>
    </div>

    <!-- ==================== SETTINGS POPUP ==================== -->
    <div id="settings-popup" class="overlay" style="display:none;">
        <div class="survey-box">
            <h2>⚙️ Settings</h2>
            <p>Choose your chat style:</p>
            <button class="style-btn" data-style="fun">🎉 Fun / Gamer</button>
            <button class="style-btn" data-style="clean">✨ Clean / Minimal</button>
            <button class="style-btn" data-style="default">🔄 Default</button>
            <br><br>
            <button id="settings-close">❌ Close</button>
        </div>
    </div>

    <!-- ==================== CHAT CONTAINER ==================== -->
    <div class="chat-container">
        <div class="welcome-banner" id="welcome-banner">
            🌟 Hey, welcome! I'm <span class="glow">YMIKICEY</span>. Let’s chat!
        </div>

        <!-- Creator login -->
        <div class="creator-login">
            <input type="password" id="creator-code" placeholder="Creator password">
            <button id="creator-btn">👑 Verify</button>
        </div>

        <!-- Mode toggle -->
        <div class="mode-toggle">
            <button id="chat-mode" class="active">💬 Chat</button>
            <button id="image-mode">🖼️ Image</button>
        </div>

        <!-- File upload -->
        <div class="upload-box">
            <input type="file" id="file-input" accept="image/*">
            <button id="upload-btn">📤 Send Screenshot</button>
        </div>

        <!-- Extra controls -->
        <div class="extra-controls">
            <button id="theme-btn">🎨 Theme</button>
            <button id="darkmode-btn">🌙 Dark/Light</button>
            <button id="settings-btn">⚙️ Settings</button>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- Input -->
        <div class="chat-input">
            <!-- 🎤 Microphone button instead of emoji -->
            <button id="mic-btn">🎤</button>
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn">Enter</button>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        let mode = "chat";
        let isCreator = false;
        let recognizing = false;
        let recognition;

        const chatBtn = document.getElementById("chat-mode");
        const imgBtn = document.getElementById("image-mode");
        const fileInput = document.getElementById("file-input");
        const uploadBtn = document.getElementById("upload-btn");
        const creatorBtn = document.getElementById("creator-btn");
        const creatorInput = document.getElementById("creator-code");
        const banner = document.getElementById("welcome-banner");
        const sendBtn = document.getElementById("send-btn");
        const messageInput = document.getElementById("message-input");
        const chatMessages = document.getElementById("chat-messages");
        const micBtn = document.getElementById("mic-btn");

        /* ---------- Speech Recognition Setup ---------- */
        if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";

            recognition.onstart = () => {
                recognizing = true;
                micBtn.textContent = "🎙️"; // active icon
            };

            recognition.onend = () => {
                recognizing = false;
                micBtn.textContent = "🎤"; // reset
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value += transcript + " ";
            };

            micBtn.addEventListener("click", () => {
                if (recognizing) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
        } else {
            micBtn.disabled = true;
            micBtn.textContent = "❌";
            console.warn("Speech Recognition not supported in this browser.");
        }

        /* ---------- Mode Toggle ---------- */
        chatBtn.addEventListener("click", () => {
            mode = "chat";
            chatBtn.classList.add("active");
            imgBtn.classList.remove("active");
        });
        imgBtn.addEventListener("click", () => {
            mode = "image";
            imgBtn.classList.add("active");
            chatBtn.classList.remove("active");
        });

        /* ---------- Add Message ---------- */
        function addMessage(sender, text, isHtml = false) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message", sender, "fade-in");

            if (sender === "bot" && isCreator) {
                msgDiv.classList.add("creator-bot");
            }
            if (isHtml) msgDiv.innerHTML = text;
            else msgDiv.textContent = text;

            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });

            if (sender === "bot") playSound();
        }

        /* ---------- Typing Indicator ---------- */
        function showTyping() {
            const typingDiv = document.createElement("div");
            typingDiv.classList.add("message", "bot", "typing-indicator");
            typingDiv.innerHTML = `
                <div class="typing">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
            return typingDiv;
        }

        /* ---------- Send Message ---------- */
        async function sendMessage() {
            const msg = messageInput.value.trim();
            if (!msg) return;
            addMessage("user", msg);
            messageInput.value = "";

            const typingDiv = showTyping();

            const response = await fetch("/send_message", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `message=${encodeURIComponent(msg)}&mode=${mode}`
            });

            const data = await response.json();
            typingDiv.remove();

            if (data.reply.startsWith("<img")) {
                addMessage("bot", data.reply, true);
            } else {
                typeWriter("bot", data.reply, 15);
            }
        }
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        /* ---------- Upload ---------- */
        uploadBtn.addEventListener("click", async () => {
            const file = fileInput.files[0];
            if (!file) return alert("Please select an image first!");
            addMessage("user", `[Uploaded Screenshot: ${file.name}]`);
            const typingDiv = showTyping();
            const formData = new FormData();
            formData.append("file", file);
            formData.append("mode", "vision");
            const response = await fetch("/send_message", { method: "POST", body: formData });
            const data = await response.json();
            typingDiv.remove();
            typeWriter("bot", data.reply, 15);
        });

        /* ---------- Typewriter ---------- */
        function typeWriter(sender, text, speed) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message", sender, "fade-in");
            if (sender === "bot" && isCreator) msgDiv.classList.add("creator-bot");
            chatMessages.appendChild(msgDiv);

            let i = 0;
            function typing() {
                if (i < text.length) {
                    msgDiv.textContent += text.charAt(i);
                    i++;
                    chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
                    setTimeout(typing, speed);
                }
            }
            typing();
            if (sender === "bot") playSound();
        }

        /* ---------- Creator Login ---------- */
        creatorBtn.addEventListener("click", async () => {
            const code = creatorInput.value.trim();
            if (!code) return;
            const response = await fetch("/identify_creator", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `code=${encodeURIComponent(code)}`
            });
            const data = await response.json();
            if (data.status === "success") {
                isCreator = true;
                addMessage("system", "👑 Creator verified! Welcome back, Yusuf!");
                document.querySelector(".creator-login").style.display = "none";
                banner.classList.add("creator-banner");
            } else {
                addMessage("system", "❌ Wrong password. Try again.");
            }
        });

        /* ---------- Survey ---------- */
        const surveyOverlay = document.getElementById("survey-overlay");
        const surveySubmit = document.getElementById("survey-submit");
        const surveySkip = document.getElementById("survey-skip");
        const whyInput = document.getElementById("survey-why");
        const sourceInput = document.getElementById("survey-source");
        document.querySelector(".chat-container").style.display = "none";

        async function submitSurvey(data) {
            await fetch("/intro_survey", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            surveyOverlay.style.display = "none";
            document.querySelector(".chat-container").style.display = "flex";
            setTimeout(() => { document.getElementById("feedback-popup").style.display = "flex"; }, 5*60*1000);
        }
        surveySubmit.addEventListener("click", () => {
            submitSurvey({ why: whyInput.value || "Not provided", source: sourceInput.value || "Not provided" });
        });
        surveySkip.addEventListener("click", () => {
            submitSurvey({ why: "Skipped", source: "Skipped" });
        });

        /* ---------- Feedback ---------- */
        document.querySelectorAll(".feedback-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                await fetch("/feedback", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ feedback: btn.dataset.feedback })
                });
                document.getElementById("feedback-popup").style.display = "none";
            });
        });

        /* ---------- Dark/Light Mode ---------- */
        const darkBtn = document.getElementById("darkmode-btn");
        darkBtn.addEventListener("click", () => {
            document.body.classList.toggle("light-mode");
            if (document.body.classList.contains("light-mode")) {
                localStorage.setItem("darkMode", "light");
            } else {
                localStorage.setItem("darkMode", "dark");
            }
        });

        /* ---------- Theme Switcher ---------- */
        const themeBtn = document.getElementById("theme-btn");
        const themes = ["blue", "purple", "green", "sunset"];
        let themeIndex = 0;
        themeBtn.addEventListener("click", () => {
            document.body.classList.remove(...themes);
            themeIndex = (themeIndex + 1) % themes.length;
            const newTheme = themes[themeIndex];
            document.body.classList.add(newTheme);
            localStorage.setItem("theme", newTheme);
        });

        /* ---------- Sound ---------- */
        function playSound() {
            const audio = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_c27b39c6d3.mp3?filename=pop-94319.mp3");
            audio.play();
        }

        /* ---------- Settings (with persistence) ---------- */
        const settingsBtn = document.getElementById("settings-btn");
        const settingsPopup = document.getElementById("settings-popup");
        const settingsClose = document.getElementById("settings-close");

        // Apply saved preferences on load
        window.addEventListener("load", () => {
            // Style
            const savedStyle = localStorage.getItem("chatStyle");
            if (savedStyle === "fun") {
                document.body.classList.add("fun-style");
            } else if (savedStyle === "clean") {
                document.body.classList.add("clean-style");
            }

            // Dark/Light
            const savedMode = localStorage.getItem("darkMode");
            if (savedMode === "light") {
                document.body.classList.add("light-mode");
            }

            // Theme
            const savedTheme = localStorage.getItem("theme");
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.add(savedTheme);
                themeIndex = themes.indexOf(savedTheme);
            }
        });

        settingsBtn.addEventListener("click", () => {
            settingsPopup.style.display = "flex";
        });
        settingsClose.addEventListener("click", () => {
            settingsPopup.style.display = "none";
        });

        document.querySelectorAll(".style-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.body.classList.remove("fun-style", "clean-style");
                if (btn.dataset.style === "fun") {
                    document.body.classList.add("fun-style");
                    localStorage.setItem("chatStyle", "fun");
                } else if (btn.dataset.style === "clean") {
                    document.body.classList.add("clean-style");
                    localStorage.setItem("chatStyle", "clean");
                } else {
                    localStorage.removeItem("chatStyle");
                }
                settingsPopup.style.display = "none";
            });
        });
    </script>
</body>
</html>
