<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YMIKICEY Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Survey Overlay -->
    <div id="survey-overlay" class="overlay">
        <div class="survey-box">
            <h2>üìù Quick Survey</h2>
            <p>Before we start, tell me a bit:</p>
            <label>Why are you gonna use this AI bot?</label>
            <input type="text" id="survey-why" placeholder="For fun, learning, etc.">
            <label>Where did you hear about it?</label>
            <input type="text" id="survey-source" placeholder="Friend, internet, etc.">
            <div class="survey-buttons">
                <button id="survey-submit" class="start">‚úÖ Start Chatting</button>
                <button id="survey-skip" class="skip">‚è≠Ô∏è Skip</button>
            </div>
        </div>
    </div>

    <!-- Feedback Popup -->
    <div id="feedback-popup" class="overlay" style="display:none;">
        <div class="survey-box">
            <h2>üí≠ Feedback</h2>
            <p>How‚Äôs your experience so far?</p>
            <button class="feedback-btn" data-feedback="good">üëç Good</button>
            <button class="feedback-btn" data-feedback="bad">üëé Bad</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="welcome-banner" id="welcome-banner">üåü Hey, welcome! I'm <span class="glow">YMIKICEY</span>. Let‚Äôs chat!</div>

        <!-- Creator login box -->
        <div class="creator-login">
            <input type="password" id="creator-code" placeholder="Creator password">
            <button id="creator-btn">üëë Verify</button>
        </div>

        <!-- Mode toggle -->
        <div class="mode-toggle">
            <button id="chat-mode" class="active">üí¨ Chat</button>
            <button id="image-mode">üñºÔ∏è Image</button>
        </div>

        <!-- File upload -->
        <div class="upload-box">
            <input type="file" id="file-input" accept="image/*">
            <button id="upload-btn">üì§ Send Screenshot</button>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- Input bar (sticks to bottom) -->
        <div class="chat-input">
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn">Enter</button>
        </div>
    </div>

    <script>
        // JS logic unchanged (same as before)
        let mode = "chat";
        let isCreator = false;

        const chatBtn = document.getElementById("chat-mode");
        const imgBtn = document.getElementById("image-mode");
        const fileInput = document.getElementById("file-input");
        const uploadBtn = document.getElementById("upload-btn");
        const creatorBtn = document.getElementById("creator-btn");
        const creatorInput = document.getElementById("creator-code");
        const banner = document.getElementById("welcome-banner");

        chatBtn.addEventListener("click", () => {
            mode = "chat";
            chatBtn.classList.add("active");
            imgBtn.classList.remove("active");
        });

        imgBtn.addEventListener("click", () => {
            mode = "image";
            imgBtn.classList.add("active");
            chatBtn.classList.remove("active");
        });

        const sendBtn = document.getElementById("send-btn");
        const messageInput = document.getElementById("message-input");
        const chatMessages = document.getElementById("chat-messages");

        function addMessage(sender, text, isHtml = false) {
            const msgDiv = document.createElement("div");

            if (sender === "bot" && isCreator) {
                msgDiv.classList.add("message", "bot", "creator-bot");
            } else {
                msgDiv.classList.add("message", sender);
            }

            if (isHtml) msgDiv.innerHTML = text;
            else msgDiv.textContent = text;

            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
        }

        function showTyping() {
            const typingDiv = document.createElement("div");
            typingDiv.classList.add("message", "bot", "typing-indicator");
            typingDiv.innerHTML = `
                <span class="glow">Y</span>
                <div class="typing">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
            return typingDiv;
        }

        async function sendMessage() {
            const msg = messageInput.value.trim();
            if (!msg) return;
            addMessage("user", msg);
            messageInput.value = "";

            const typingDiv = showTyping();

            const response = await fetch("/send_message", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `message=${encodeURIComponent(msg)}&mode=${mode}`
            });

            const data = await response.json();
            typingDiv.remove();

            if (data.reply.startsWith("<img")) {
                addMessage("bot", data.reply, true);
            } else {
                typeWriter("bot", data.reply, 15);
            }
        }

        uploadBtn.addEventListener("click", async () => {
            const file = fileInput.files[0];
            if (!file) return alert("Please select an image first!");

            addMessage("user", `[Uploaded Screenshot: ${file.name}]`);

            const typingDiv = showTyping();

            const formData = new FormData();
            formData.append("file", file);
            formData.append("mode", "vision");

            const response = await fetch("/send_message", {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            typingDiv.remove();

            typeWriter("bot", data.reply, 15);
        });

        function typeWriter(sender, text, speed) {
            const msgDiv = document.createElement("div");

            if (sender === "bot" && isCreator) {
                msgDiv.classList.add("message", "bot", "creator-bot");
            } else {
                msgDiv.classList.add("message", sender);
            }

            chatMessages.appendChild(msgDiv);

            let i = 0;
            function typing() {
                if (i < text.length) {
                    msgDiv.textContent += text.charAt(i);
                    i++;
                    chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
                    setTimeout(typing, speed);
                }
            }
            typing();
        }

        creatorBtn.addEventListener("click", async () => {
            const code = creatorInput.value.trim();
            if (!code) return;

            const response = await fetch("/identify_creator", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `code=${encodeURIComponent(code)}`
            });

            const data = await response.json();
            if (data.status === "success") {
                isCreator = true;
                addMessage("system", "üëë Creator verified! Welcome back, Yusuf!");
                document.querySelector(".creator-login").style.display = "none";
                banner.classList.add("creator-banner");
            } else {
                addMessage("system", "‚ùå Wrong password. Try again.");
            }
        });

        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Survey Logic
        const surveyOverlay = document.getElementById("survey-overlay");
        const surveySubmit = document.getElementById("survey-submit");
        const surveySkip = document.getElementById("survey-skip");
        const whyInput = document.getElementById("survey-why");
        const sourceInput = document.getElementById("survey-source");

        document.querySelector(".chat-container").style.display = "none";

        async function submitSurvey(data) {
            await fetch("/intro_survey", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            surveyOverlay.style.display = "none";
            document.querySelector(".chat-container").style.display = "flex";

            setTimeout(() => {
                document.getElementById("feedback-popup").style.display = "flex";
            }, 5 * 60 * 1000);
        }

        surveySubmit.addEventListener("click", () => {
            submitSurvey({
                why: whyInput.value || "Not provided",
                source: sourceInput.value || "Not provided"
            });
        });

        surveySkip.addEventListener("click", () => {
            submitSurvey({
                why: "Skipped",
                source: "Skipped"
            });
        });

        document.querySelectorAll(".feedback-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                await fetch("/feedback", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ feedback: btn.dataset.feedback })
                });
                document.getElementById("feedback-popup").style.display = "none";
            });
        });
    </script>
</body>
</html>
